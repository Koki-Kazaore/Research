# 機械学習モデルの設計

数理最適化ベースの割り当てモデルの場合，整数計画問題を解く際に多くの計算量を要することや，一定期間(本研究では1分間)のリクエストをストックした上で最適化処理の計算を行うため，どうしてもユーザの待ち時間が発生してしまう課題が挙げられる．実際に本研究にて構築している数理最適化ベースの自転車割り当てモデルは二分割マッチング問題として捉えることができ，アルゴリズムの複雑性をオーダ表記するとO(??)となる．しかし，実際のサービス運用下では，より高速なレスポンスで尚且つ正確な割り当て処理が求められる．そこでANN(Artifical Newral Network)ベースの割り当てモデルを設計する．ANNは訓練に長い時間を要するものの，訓練後のニューラルネットワークに基づく出力は高速であるため，数理最適化ベースの割り当てモデルの課題点の克服が期待できる．

数理最適化ベースの割り当てモデルと同様に，ユーザが自転車をリクエストする際には，そのユーザの現在地と目的地，それに伴うユーザの現在地と自転車の駐輪位置の距離，ユーザの目的地と自転車の所有者の距離は既知情報であることが前提である．割り当てモデルはそれぞれのリクエストに対して利用可能な自転車が存在する場合に1台の自転車をレスポンスする．ユーザリクエストと自転車の各ペアに対して表??に示すように10の入力変数が存在する．これらは，ユーザの現在地と目的地を含めた「ユーザの状態」や，自転車の現在地や自転車の所有者との位置関係を含めた「自転車の状態」，ユーザと自転車の位置関係，現在時刻を含んでいる．ニューラルネットワークは，これらの入力変数を元にあるユーザに対してある自転車を割り当てる確率を計算する．

| 入力変数 | 説明 |
| ----- | ----- |
| $x1$ | ユーザリクエスト$r$の現在地経度 |
| $x2$ | ユーザリクエスト$r$の現在地緯度 |
| $x3$ | ユーザリクエスト$r$の目的地緯度 |
| $x4$ | ユーザリクエスト$r$の目的地経度 |
| $x5$ | 自転車$b$の現在地経度 |
| $x6$ | 自転車$b$の現在地緯度 |
| $x7$ | 自転車$b$の所有者位置経度 |
| $x8$ | 自転車$b$の所有者位置緯度 |
| $x9$ | ユーザリクエスト$r$と自転車$b$までの距離 |
| $x10$ | タイムスタンプ(1日の始まりからの経過分数) |

<!-- ここのニューロン数については再検討必要。 -->
ANNは，図??に示すように，10ニューロンの入力層，それぞれ??ニューロン，??ニューロン，??ニューロンで構成された?つの隠れ層，1ニューロンの出力層で構成されている．これらのハイパーパラメータは??という理由で決定した．各ニューロンは前の層の全ニューロンに接続されている．最終出力となるモデル推定値は順伝播により計算される．層からの出力は以下式で求める．

$$ a^{l+1} = g^{l+1}(W^{(l+1)T}a^l + b^{l+1}) $$

ここで$l$はニューラルネットワークにおける$l$番目の層を示す．$a^{l+1}$は$l+1$層からの出力ベクトルを表し，$a^1 = X$は入力ベクトルとなる．$W^(l+1)$は層$l$と層$l+1$の間の接続における重み行列である．$b^{l+1}$はバイアスベクトルを表し，$g^{l+1}(\cdot)$は層$l+1$の活性化関数を表す．

?つの隠れ層は以下式のようにReLU関数で活性化される．出力層は以下式のようにシグモイド関数で活性化される．出力はユーザリクエスト$r$に対して自転車$b$を割り当てる予測確立であり，$p_{b,r}$と表記する．$p_{b,r}$が閾値より小さい場合は0，$p_{b,r}$が閾値以上の場合は1として対応するユーザリクエストと自転車のペアを割り当て結果の候補とする．さらに，オーバーフィッティングを防ぐため，1層目と2層目の後にドロップアウトを??のドロップ率で実装する．

$$ ReLU(x) = max(0, x) $$
$$ \sigma(x) = \dfrac{1}{1 + e^{-x}} $$

この二値分類問題の損失関数として，以下の指揮に示すようにバイナリクロスエントロピを用いる．ニューラルネットワークはこの損失関数を最小化するように学習する．

$$ L(y, p) = -\dfrac{1}{N}\sum_{k=1}^{N}y_k\log(p_k) + (1- y)\log(1 - p_k) $$

ここで，$y_k$は$k$番目のユーザ・自転車ペアの真のクラスを表し，$p_k$は$k$番目のユーザ・自転車ペアに対して予測される割り当て確率を表している．$N$はユーザリクエストと自転車のペアの総数を表す．

ニューラルネットワークはユーザリクエストと自転車のペアごとに割り当て確率を算出するため，アルゴリズムの複雑性をオーダ表記するとO(??)となる．

また，ニューラルネットワークの予測確率のみでどのユーザにどの自転車を割り当てるべきかを決定することはできない．図??に示す例の通り，ユーザリクエストと自転車のペアには重複がある可能性が存在する．例えば自転車AがユーザA，ユーザB，ユーザCに割り当てられる確率がそれぞれ0.5, 0.6, 0.7だった場合でも，自転車は複数ユーザで同時に利用することはできない．

このようなオーバーラップ問題対策として，以下のようなアルゴリズムを元に，ニューラルネットワークの出力を参考にして最終的な割り当て結果を判定する．

```
Input:
  user requests R
  available bikes B,
  bike-request pairs b-r (b in B, r in R),
  probalities of dispatching p(b,r) (b in B, r in R)

Output:
  Which bike b should be dispatched to pick up which user request r

Algorithm:
  while B ≠ 空集合 and R ≠ 空集合 do
    find the largest probability of dispatching p(max)
    if p(max) >= 0.5 then
      Find the corresponding b-r pair
      Dispatch bike b to user request r
      Remove all the bike-request pairs that have b or r
      B <- B - b
      R <- R - r
    else then
      break
    end if
  end while
```

# モデルの学習
ANNベースの割り当てモデルは，[機械学習モデルの設計](#機械学習モデルの設計)にて述べた通り，数理最適化ベースの割り当てモデルから最適な割り当て結果を元に学習する．2023年1月1日の0:00から2023年1月2日の0:00までの連続する24時間におけるニューヨーク市のイエロータクシーの利用データを抽出し，数理最適化ベースの割り当てモデルで割り当てシミュレーションを行った．数理最適化ベースの割り当て結果をテストデータセットとして使用する．このテストデータセットに機械学習モデルに適用したところ，機械学習モデルの制度は??，再現率は??となった．